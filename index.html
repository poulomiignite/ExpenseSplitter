import React, { useState, useMemo, useEffect, useCallback } from 'react';

// --- TYPES ---
export interface Person {
  id: string;
  name: string;
}

export type SplitMethod = 'equally' | 'parts' | 'percentage' | 'amount';

export interface Split {
  personId: string;
  value: number;
}

export interface Expense {
  id: string;
  description: string;
  amount: number;
  paidBy: string;
  splitMethod: SplitMethod;
  splits: Split[];
}

export interface Group {
  id: string;
  name: string;
  people: Person[];
  expenses: Expense[];
  currency: string;
  createdAt: number;
}

export interface Balance {
  personId: string;
  name: string;
  amount: number;
}

export interface Transaction {
  from: string;
  to: string;
  amount: number;
}

// --- UTILS (settle.ts) ---
const calculateBalances = (people: Person[], expenses: Expense[]): Balance[] => {
  const balanceMap: { [key: string]: number } = {};
  people.forEach(p => { balanceMap[p.id] = 0; });
  expenses.forEach(expense => {
    balanceMap[expense.paidBy] += expense.amount;
    let totalParts = 0;
    if (expense.splitMethod === 'parts') {
      totalParts = expense.splits.reduce((sum, s) => sum + s.value, 0);
    }
    expense.splits.forEach(split => {
      let share = 0;
      switch (expense.splitMethod) {
        case 'equally': share = expense.amount / expense.splits.length; break;
        case 'amount': share = split.value; break;
        case 'percentage': share = (expense.amount * split.value) / 100; break;
        case 'parts': if (totalParts > 0) share = (expense.amount * split.value) / totalParts; break;
      }
      balanceMap[split.personId] -= share;
    });
  });
  return people.map(p => ({
    personId: p.id,
    name: p.name,
    amount: balanceMap[p.id],
  })).sort((a,b) => b.amount - a.amount);
};

const calculateSettlement = (balances: Balance[]): Transaction[] => {
  const transactions: Transaction[] = [];
  const debtors = JSON.parse(JSON.stringify(balances.filter(b => b.amount < -0.01)));
  const creditors = JSON.parse(JSON.stringify(balances.filter(b => b.amount > 0.01)));
  debtors.forEach((d: any) => d.amount = -d.amount);
  debtors.sort((a: any, b: any) => b.amount - a.amount);
  creditors.sort((a: any, b: any) => b.amount - a.amount);
  let dIdx = 0, cIdx = 0;
  while (dIdx < debtors.length && cIdx < creditors.length) {
    const amount = Math.min(debtors[dIdx].amount, creditors[cIdx].amount);
    if (amount > 0.005) {
      transactions.push({ from: debtors[dIdx].name, to: creditors[cIdx].name, amount });
      debtors[dIdx].amount -= amount;
      creditors[cIdx].amount -= amount;
    }
    if (debtors[dIdx].amount < 0.01) dIdx++;
    if (creditors[cIdx].amount < 0.01) cIdx++;
  }
  return transactions;
};

// --- ICONS ---
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>,
  Users: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0115 11h1c.07 0 .137.01.2.03.003.001.006.002.009.003a1 1 0 01.707.293l2 2a1 1 0 01-1.414 1.414l-1.44-1.44zM4 11a5 5 0 014.545-2.964.5.5 0 00.454-.296A6.978 6.978 0 009 7c-1.355 0-2.62.433-3.662 1.162A5 5 0 004 11zM2 12a6 6 0 006 6h2a6 6 0 006-6 1 1 0 10-2 0 4 4 0 01-4 4H8a4 4 0 01-4-4 1 1 0 10-2 0z" /></svg>,
  Home: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
  Activity: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
  User: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
  Settings: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>,
  ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" /></svg>,
  Trash: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>,
  Pencil: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>,
  Link: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>,
  Globe: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-3.5 h-3.5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9s-2.015-9-4.5-9m0 18c-2.485 0-4.5-4.03-4.5-9s2.015-9 4.5-9m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582" /></svg>,
  Clipboard: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>,
  ClipboardCheck: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
  ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
};

// --- CONSTANTS ---
const CURRENCIES: { [key: string]: string } = { EUR: 'â‚¬', USD: '$', GBP: 'Â£', INR: 'â‚¹', JPY: 'Â¥', HKD: 'HK$', CAD: 'C$' };
const DEFAULT_GROUPS: Group[] = [{ id: 'default-1', name: 'Apartment', people: [{ id: '1', name: 'Alice' }, { id: '2', name: 'Bob' }], expenses: [], currency: 'EUR', createdAt: Date.now() }];

// --- SUB-COMPONENTS (Consolidated) ---

const NavButton = ({ active, onClick, icon, label }: any) => (
  <button onClick={onClick} className={`flex flex-col items-center gap-1 transition-all ${active ? 'text-indigo-600 scale-110' : 'text-stone-300'}`}>
    <div className="text-xl">{icon}</div>
    <span className="text-[10px] font-black uppercase tracking-widest">{label}</span>
  </button>
);

const AddPersonForm = ({ onAddPerson }: any) => {
  const [name, setName] = useState('');
  const [isExpanding, setIsExpanding] = useState(false);
  const handleSubmit = (e: any) => { e.preventDefault(); if (name.trim()) { onAddPerson(name.trim()); setName(''); setIsExpanding(false); } };
  return isExpanding ? (
    <form onSubmit={handleSubmit} className="flex flex-col items-center gap-2 animate-in zoom-in">
      <input autoFocus type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Name" className="w-20 px-2 py-1 bg-white border border-stone-200 rounded-lg text-xs font-bold focus:ring-2 focus:ring-indigo-500" />
      <div className="flex gap-1"><button type="submit" className="text-[10px] bg-indigo-500 text-white px-2 py-0.5 rounded-full font-bold">OK</button></div>
    </form>
  ) : (
    <button onClick={() => setIsExpanding(true)} className="w-14 h-14 rounded-2xl border-2 border-dashed border-stone-200 flex items-center justify-center text-stone-400"><Icons.Plus /></button>
  );
};

const BalanceSummary = ({ balances, currencySymbol }: any) => {
  const totalPool = balances.filter((b:any) => b.amount > 0).reduce((acc:any, b:any) => acc + b.amount, 0);
  return (
    <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-stone-50">
      <div className="flex justify-between items-end mb-6">
        <div><h2 className="text-xs font-bold text-stone-400 uppercase tracking-widest mb-1">Total Pool</h2><p className="text-4xl font-black text-stone-900">{currencySymbol}{totalPool.toFixed(2)}</p></div>
        <span className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold uppercase">Active Group</span>
      </div>
      <div className="space-y-2">
        {balances.map((b: any) => (
          <div key={b.personId} className="flex justify-between items-center py-3 px-4 rounded-2xl hover:bg-stone-50">
            <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-xs font-bold text-stone-500">{b.name[0]}</div><span className="font-bold text-stone-700">{b.name}</span></div>
            <div className={`font-black ${b.amount > 0.01 ? 'text-emerald-500' : b.amount < -0.01 ? 'text-rose-500' : 'text-stone-300'}`}>{b.amount > 0.01 ? '+' : ''}{currencySymbol}{b.amount.toFixed(2)}</div>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- MAIN APP COMPONENT ---
const App: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'groups' | 'friends' | 'activity' | 'account'>('groups');
  const [groups, setGroups] = useState<Group[]>(() => {
    const saved = window.localStorage.getItem('basushare_groups');
    return saved ? JSON.parse(saved) : DEFAULT_GROUPS;
  });
  const [activeGroupId, setActiveGroupId] = useState(() => window.localStorage.getItem('basushare_active_group') || DEFAULT_GROUPS[0].id);
  const [isExpenseModalOpen, setExpenseModalOpen] = useState(false);
  const [isAddingGroup, setIsAddingGroup] = useState(false);
  const [newGroupName, setNewGroupName] = useState('');

  const activeGroup = useMemo(() => groups.find(g => g.id === activeGroupId) || groups[0], [groups, activeGroupId]);
  const { people, expenses, currency } = activeGroup;
  const currencySymbol = CURRENCIES[currency] || 'â‚¬';

  useEffect(() => {
    window.localStorage.setItem('basushare_groups', JSON.stringify(groups));
    window.localStorage.setItem('basushare_active_group', activeGroupId);
  }, [groups, activeGroupId]);

  const updateActiveGroup = (updates: Partial<Group>) => setGroups(groups.map(g => g.id === activeGroupId ? { ...g, ...updates } : g));

  const balances = useMemo(() => calculateBalances(people, expenses), [people, expenses]);
  const transactions = useMemo(() => calculateSettlement(balances), [balances]);

  return (
    <div className="min-h-screen bg-[#F9FAFB] pb-32">
      <header className="sticky top-0 z-30 bg-white border-b border-stone-100 px-6 py-4 flex justify-between items-center">
        <div className="flex items-center gap-2"><div className="bg-indigo-600 p-2 rounded-xl text-white"><Icons.Users /></div><h1 className="text-lg font-black text-stone-900">BasuShare</h1></div>
        <button onClick={() => setActiveTab('account')} className="p-2 text-stone-400"><Icons.Settings /></button>
      </header>
      
      <main className="max-w-2xl mx-auto px-4 pt-6">
        {activeTab === 'groups' && (
          <div className="space-y-6 animate-in slide-in-from-bottom-2">
            <div className="flex justify-between items-center px-2"><h2 className="text-2xl font-black text-stone-900">Groups</h2><button onClick={() => setIsAddingGroup(true)} className="text-indigo-600 font-bold text-sm">+ Add Group</button></div>
            {isAddingGroup && (
              <form onSubmit={e => { e.preventDefault(); if(newGroupName.trim()){ const ng = { id: Math.random().toString(36).substr(2,9), name: newGroupName.trim(), people: [{id:'1', name:'Me'}], expenses:[], currency:'EUR', createdAt:Date.now() }; setGroups([...groups, ng]); setActiveGroupId(ng.id); setNewGroupName(''); setIsAddingGroup(false); } }} className="bg-white p-4 rounded-3xl shadow-lg border-2 border-indigo-500">
                <input autoFocus className="w-full bg-stone-100 p-4 rounded-2xl font-bold mb-3" placeholder="Group Name" value={newGroupName} onChange={e=>setNewGroupName(e.target.value)} />
                <div className="flex gap-2"><button type="submit" className="flex-1 bg-indigo-600 text-white py-3 rounded-full font-bold">Create</button><button onClick={()=>setIsAddingGroup(false)} className="flex-1 bg-stone-100 py-3 rounded-full font-bold">Cancel</button></div>
              </form>
            )}
            <div className="space-y-3">
              {groups.map(g => (
                <button key={g.id} onClick={() => setActiveGroupId(g.id)} className={`w-full flex items-center justify-between p-5 rounded-[2rem] transition-all ${g.id === activeGroupId ? 'bg-white shadow-xl border-2 border-indigo-600' : 'bg-white border hover:bg-stone-50'}`}>
                  <div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-bold ${g.id === activeGroupId ? 'bg-indigo-600 text-white' : 'bg-stone-100'}`}>{g.name[0]}</div><div className="text-left"><h3 className="font-bold">{g.name}</h3><p className="text-[10px] font-black uppercase text-stone-400">{g.people.length} Members â€¢ {CURRENCIES[g.currency]}</p></div></div>
                </button>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'friends' && (
          <div className="space-y-6 animate-in fade-in">
            <div className="flex justify-between items-center px-2"><h2 className="text-2xl font-black text-stone-900">People</h2><AddPersonForm onAddPerson={(name:string) => updateActiveGroup({ people: [...people, { id: Math.random().toString(36).substr(2,9), name }] })} /></div>
            <BalanceSummary balances={balances} currencySymbol={currencySymbol} />
          </div>
        )}

        {activeTab === 'activity' && (
          <div className="space-y-6 animate-in fade-in">
            <div className="flex justify-between items-center px-2"><h2 className="text-2xl font-black text-stone-900">Activity</h2><button onClick={() => updateActiveGroup({ expenses: [] })} className="text-sm font-bold text-emerald-600 bg-emerald-50 px-4 py-2 rounded-full">Clear All</button></div>
            {expenses.length === 0 ? <div className="py-20 text-center text-stone-400 font-bold uppercase tracking-widest text-xs">No activity yet</div> : (
              expenses.slice().reverse().map(e => (
                <div key={e.id} className="bg-white p-5 rounded-[2rem] shadow-sm border border-stone-100 flex items-center justify-between">
                  <div className="flex items-center gap-4"><div className="w-14 h-14 rounded-2xl bg-indigo-50 flex items-center justify-center text-2xl">ðŸ’¸</div><div><h3 className="font-bold">{e.description}</h3><p className="text-[10px] font-black uppercase text-stone-400">{people.find(p=>p.id===e.paidBy)?.name} paid {currencySymbol}{e.amount}</p></div></div>
                  <div className="text-right font-black text-xl">{currencySymbol}{e.amount}</div>
                </div>
              ))
            )}
          </div>
        )}

        {activeTab === 'account' && (
          <div className="space-y-6 animate-in fade-in">
            <h2 className="text-2xl font-black text-stone-900 px-2">Account</h2>
            <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden p-6 flex justify-between items-center">
              <div><h3 className="font-bold">Currency</h3><p className="text-xs text-stone-400">Current: {currency}</p></div>
              <select value={currency} onChange={e => updateActiveGroup({ currency: e.target.value })} className="bg-stone-100 px-4 py-2 rounded-full font-bold border-none outline-none">{Object.keys(CURRENCIES).map(c => <option key={c} value={c}>{c}</option>)}</select>
            </div>
          </div>
        )}
      </main>

      <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-40">
        <button onClick={() => setExpenseModalOpen(true)} className="bg-indigo-600 text-white flex items-center gap-2 px-8 py-4 rounded-full shadow-2xl font-bold active:scale-95 transition-all"><Icons.Plus /><span>Add Expense</span></button>
      </div>

      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-4 flex justify-between items-center z-30 sm:max-w-2xl sm:mx-auto sm:mb-4 sm:rounded-full sm:shadow-2xl">
        <NavButton active={activeTab === 'groups'} onClick={() => setActiveTab('groups')} icon={<Icons.Home />} label="Groups" />
        <NavButton active={activeTab === 'friends'} onClick={() => setActiveTab('friends')} icon={<Icons.User />} label="Friends" />
        <div className="w-12" />
        <NavButton active={activeTab === 'activity'} onClick={() => setActiveTab('activity')} icon={<Icons.Activity />} label="Activity" />
        <NavButton active={activeTab === 'account'} onClick={() => setActiveTab('account')} icon={<Icons.Settings />} label="Account" />
      </nav>

      {isExpenseModalOpen && (
        <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-50 flex justify-center items-end sm:items-center animate-in fade-in" onClick={()=>setExpenseModalOpen(false)}>
           <div className="bg-white rounded-t-[2.5rem] sm:rounded-[2.5rem] w-full max-w-lg p-8 animate-in slide-in-from-bottom" onClick={e=>e.stopPropagation()}>
              <h2 className="text-2xl font-black mb-6">New Expense</h2>
              <form onSubmit={e => { e.preventDefault(); const desc = (e.target as any).desc.value; const amt = parseFloat((e.target as any).amt.value); if(desc && amt){ updateActiveGroup({ expenses: [...expenses, { id: Date.now().toString(), description: desc, amount: amt, paidBy: people[0].id, splitMethod: 'equally', splits: people.map(p=>({personId:p.id, value:1})) }] }); setExpenseModalOpen(false); } }}>
                <input name="desc" placeholder="What's it for?" className="w-full text-2xl font-bold mb-4 outline-none border-b-2 border-stone-100 focus:border-indigo-600 py-2" />
                <input name="amt" type="number" placeholder="0.00" className="w-full text-4xl font-black mb-8 outline-none text-rose-500" />
                <button type="submit" className="w-full py-5 bg-stone-900 text-white font-black rounded-full shadow-xl">Confirm</button>
              </form>
           </div>
        </div>
      )}
    </div>
  );
};

export default App;
